import unittest
import tempfile
import shutil
import os

TEST_DATA = "data/invest-test-data/coastal_vulnerability"
TEST_WORKSPACE_DIR = "../invest_dev/coastal_vulnerability/test_workspace"
_SMALLEST_FEATURE_SIZE = 10000
_MAX_FETCH_DISTANCE = 60000

class CoastalVulnerabilityTests(unittest.TestCase):
    """Tests for the Coastal Vulnerability Model."""

    def setUp(self):
        """Overriding setUp function to create temp workspace directory."""
        # this lets us delete the workspace after its done no matter the
        # the rest result
        self.workspace_dir = tempfile.mkdtemp()

    def tearDown(self):
        """Overriding tearDown function to remove temporary directory."""
        shutil.rmtree(self.workspace_dir)

    @unittest.skip("skip shore points")
    def test_shore_points(self):
        from natcap.invest import coastal_vulnerability

        working_dir = os.path.join(TEST_WORKSPACE_DIR, "shore_points")
        wwiii_vector_path = os.path.join(TEST_DATA, "WaveWatchIII_subset.shp")
        wwiii_rtree_path = os.path.join(working_dir, "wwiii_rtree.dat")
        landmass_vector_path = os.path.join(
            TEST_DATA, "land_polygon_simple_utm.shp")
        target_shore_point_vector_path = os.path.join(
            working_dir, "shore_points.shp")

        if os.path.exists(working_dir):
            shutil.rmtree(working_dir)
        os.makedirs(working_dir)

        coastal_vulnerability.build_wwiii_rtree(
            wwiii_vector_path, wwiii_rtree_path)

        coastal_vulnerability.create_shore_points(
            landmass_vector_path, wwiii_vector_path, wwiii_rtree_path,
            _SMALLEST_FEATURE_SIZE, working_dir, target_shore_point_vector_path)

    @unittest.skip("skip wind and ray")
    def test_wind_exposure_and_ray_fetch(self):
        from natcap.invest import coastal_vulnerability

        working_dir = os.path.join(TEST_WORKSPACE_DIR, "wind")
        base_shore_point_vector_path = os.path.join(
            TEST_DATA, "shore_points_utm.shp")
        landmass_vector_path = os.path.join(
            TEST_DATA, "land_polygon_simple_utm.shp")
        landmass_rtree_path = os.path.join(working_dir, "land_rtree.dat")
        target_fetch_point_vector_path = os.path.join(
            working_dir, "fetch_points.gpkg")

        if os.path.exists(working_dir):
            shutil.rmtree(working_dir)
        os.makedirs(working_dir)

        coastal_vulnerability.build_feature_bounding_box_rtree(
            landmass_vector_path, landmass_rtree_path)

        coastal_vulnerability.calculate_wind_exposure(
            base_shore_point_vector_path,
            landmass_rtree_path, landmass_vector_path, working_dir,
            _SMALLEST_FEATURE_SIZE, _MAX_FETCH_DISTANCE,
            target_fetch_point_vector_path)

    @unittest.skip("skip habitat")
    def test_habitat_rank(self):
        from natcap.invest import coastal_vulnerability

        base_shore_point_vector_path = os.path.join(TEST_DATA, "shore_points.shp")
        habitat_table_path = os.path.join(TEST_DATA, "natural_habitats_wcvi.csv")
        working_dir = os.path.join(TEST_WORKSPACE_DIR, 'habitat_dir')
        target_habitat_protection_path = os.path.join(working_dir, 'habitat_protection.csv')

        coastal_vulnerability.calculate_habitat_protection(
            base_shore_point_vector_path,
            habitat_table_path, working_dir,
            target_habitat_protection_path)

    @unittest.skip("skip geomorphology")
    def test_geomorphology_rank(self):
        from natcap.invest import coastal_vulnerability

        geomorphology_vector_path = os.path.join(
            "C:/Users/dmf/projects/invest-sample-data/CoastalProtection/Input", "Geomorphology_BarkClay.shp")
        grid_raster_path = os.path.join(TEST_DATA, "grid_utm.tif")
        working_dir = os.path.join(TEST_WORKSPACE_DIR, 'geomorphology')
        target_geomorphology_raster_path = os.path.join(
            working_dir, 'final_geomorphology_rank.tif')
        base_shore_point_vector_path = os.path.join(TEST_DATA, "shore_points.shp")
        target_pickle_path = os.path.join(working_dir, 'geomorphology.pickle')

        coastal_vulnerability.calculate_geomorphology_exposure(
            geomorphology_vector_path,
            grid_raster_path, working_dir,
            target_geomorphology_raster_path,
            base_shore_point_vector_path,
            target_pickle_path)

    @unittest.skip("skip surge")
    def test_surge_exposure_rank(self):
        from natcap.invest import coastal_vulnerability

        base_shore_point_vector_path = os.path.join(TEST_DATA, "shore_points.shp")
        bathymetry_dem_path = os.path.join(
            "C:/Users/dmf/projects/invest-sample-data/Base_Data/Marine/DEMs/global_dem/", "hdr.adf")
        aoi_vector_path = os.path.join(TEST_DATA, 'AOI_BarkClay.shp')
        smallest_feature_size = 8000
        depth_contour = -150
        workspace_dir = os.path.join(TEST_WORKSPACE_DIR, 'surge')
        target_surge_pickle_path = os.path.join(workspace_dir, 'surge.pickle')

        coastal_vulnerability.calculate_surge_exposure(
            base_shore_point_vector_path, bathymetry_dem_path, aoi_vector_path,
            smallest_feature_size, depth_contour, workspace_dir,
            target_surge_pickle_path)

    # @unittest.skip("skip complete run")
    def test_complete_run(self):
        from natcap.invest import coastal_vulnerability

        args = {'workspace_dir': 'C:/Users/dmf/projects/invest_dev/coastal_vulnerability/test_workspace',
                'n_workers': -1,
                'wwiii': os.path.join(TEST_DATA, 'WaveWatchIII_subset.shp'),
                'landmass_vector_path': os.path.join(TEST_DATA, 'land_polygon_simple_utm.shp'),
                'aoi_vector_path': os.path.join(TEST_DATA, 'AOI_BarkClay.shp'),
                'smallest_feature_size': 8000,
                'max_fetch_distance': 60000,
                'dem': "C:/Users/dmf/projects/invest-sample-data/Base_Data/Marine/DEMs/global_dem/hdr.adf",
                'dem_averaging_radius': 5000.0,
                'habitat_table_path': os.path.join(TEST_DATA, "natural_habitats_wcvi.csv"),
                'geomorphology_vector_path': os.path.join(
                    "C:/Users/dmf/projects/invest-sample-data/CoastalProtection/Input", "Geomorphology_BarkClay.shp"),
                'bathymetry': os.path.join(
                    "C:/Users/dmf/projects/invest-sample-data/Base_Data/Marine/DEMs/global_dem/", "hdr.adf"),
                'depth_contour': -150,
                }

        coastal_vulnerability.execute(args)


    # def test_bin_values_to_percentiles(self):